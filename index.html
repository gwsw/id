<!doctype html>
<meta charset="UTF-8">
<html>
<head>
<title>Intensity Mapper</title>
</head>
<body onload="main()">
<canvas id="canvas" width="1" height="1" style="font-family:Arial"></canvas>
<br>
<table id="ctls">
 <tr>
  <td> Input </td>
  <td> Output </td>
 </tr>
 <tr>
  <td>
   <select name="input" id="sel_input" onchange="Game._event_io_changed()">
    <option value="pulse"> Pulse </option>
   </select>
  </td>
  <td>
   <select name="output" id="sel_output" onchange="Game._event_io_changed()">
    <option value="rect"> Rect </option>
    <option value="widen"> Widen </option>
   </select>
  </td>
  <td>
  </td>
 </tr>
</table>

<script src="../jlib/gfx.js"></script>

<script>

// --------------------------------------------------------------------
// Globals
var _game = null;

var config = {
    pulse_period           : 3500,

    color_meter_fg         : "a05010",
    color_meter_bg         : "000000",
    color_bg               : "002050",
};

// --------------------------------------------------------------------
class ID { // interface
    constructor(input, output) {
        this.input = input;
        this.output = output;
        this.set_intensity(0);
    }
    set_intensity(intens) {
        this.intens = intens;
    }
    update() {
        this.set_intensity(this.input.get_intensity());
    }
    draw(gfx, x, y, w, h) {
        this.output.set_intensity(this.intens);
        this.output.draw(gfx, x, y, w, h);
    }
};

// --------------------------------------------------------------------
class ID_Input { // interface
    constructor() {
    }
    get_intensity() { pure(); }
};

// --------------------------------------------------------------------
class ID_Output { // interface
    constructor() {
    }
    set_intensity(intens) { pure(); }
    draw(gfx, x, y, w, h) { pure(); }
};

// --------------------------------------------------------------------
class ID_RectMeter extends ID_Output {
    constructor(fg, bg) {
        super();
        this.fg = fg;
        this.bg = bg;
        this.set_intensity(0);
    }
    set_intensity(intens) {
        this.intens = intens;
    }
    draw(gfx, x, y, w, h) {
        gfx.draw_rect(x, y, w, h, this.bg);
        let wa = w * this.intens;
        gfx.draw_rect(x, y, wa, h, this.fg);
    }
};

// --------------------------------------------------------------------
class ID_WidenMeter extends ID_Output {
    constructor(fg, bg) {
        super();
        this.fg = fg;
        this.bg = bg;
        this.set_intensity(0);
    }
    set_intensity(intens) {
        this.intens = intens;
    }
    draw(gfx, x, y, w, h) {
        gfx.draw_rect(x, y, w, h, this.bg);
        let wa = w * this.intens / 2;
        ///gfx.draw_rect(x + wa, y, 2*wa, h, this.fg);
        gfx.draw_rect(x + w/2 - wa, y, 2*wa, h, this.fg);
    }
};

// --------------------------------------------------------------------
class ID_Pulse extends ID_Input {
    constructor(period) {
        super();
        if (period == 0) period = 1;
        this.period = period;
    }
    get_intensity() {
        const phase = (now() % this.period) / this.period;
        let intens = Math.sin(2*Math.PI * phase);
        if (intens < 0) intens = -intens;
        return intens;
    }
};

// --------------------------------------------------------------------
class Game {
    constructor(gfx, w, h, input, output) {
        this.gfx = gfx;
        this.stopping = false;
        this.new_id(0, 0);
    }
    new_id(input_type, output_type) {
        const input = Game.new_input(input_type);
        const output = Game.new_output(output_type);
        this.id = input && output ? new ID(input, output) : null;
    }
    static new_input(type) {
        switch (type) {
        case 0: return new ID_Pulse(5500);
        }
        return null;
    }
    static new_output(type) {
        switch (type) {
        case 0: return new ID_RectMeter(config.color_meter_fg, config.color_meter_bg);
        case 1: return new ID_WidenMeter(config.color_meter_fg, config.color_meter_bg);
        }
        return null;
    }
    resize(width, height) {
        const s = Math.min(width, height);
        this.gfx.set_font_size(s*.040);
        this.draw();
    }
    run() {
        const intens = this.id.input.get_intensity();
        this.id.set_intensity(intens);
        this.draw();
        if (this.stopping) {
            this.stopping = false;
            return false;
        }
        return true;
    }
    stop() {
        this.stopping = true;
        while (this.stopping) {
            run_game();
        }
    }
    draw() {
        this.gfx.clear(config.color_bg);
        this.id.draw(this.gfx, 40, 80, 200, 60);
    }
    event_mouse(event, x, y) {
        if (event == Game.MOUSE_DOWN) {
            ///this.draw();
        }
    }
    static _event_io_changed() {
        if (_game != null) { _game.stop(); }
        const input = el("sel_input").selectedIndex;
        const output = el("sel_output").selectedIndex;
        _game.new_id(input, output);
    }

    static _event_mousedown(e) { if (_game != null) _game.event_mouse(Game.MOUSE_DOWN, e.offsetX, e.offsetY); }
    static _event_mouseup(e) { if (_game != null) _game.event_mouse(Game.MOUSE_UP, e.offsetX, e.offsetY); }
    static _event_mousemove(e) { if (_game != null) _game.event_mouse(Game.MOUSE_MOVE, e.offsetX, e.offsetY); }

    static MOUSE_DOWN = 0;
    static MOUSE_UP   = 1;
    static MOUSE_MOVE = 2;
}; // class Game

// --------------------------------------------------------------------
function canvas_to_window() {
    const canvas = el("canvas");
    const s = 20;
    canvas.width = window.innerWidth - s;
    canvas.height = window.innerHeight/2 - s;
    return canvas;
}

function canvas_resize() {
    const canvas = canvas_to_window();
    if (_game != null) _game.resize(canvas.width, canvas.height);
}

function run_game() {
    if (_game == null) return;
    if (_game.run())
        window.requestAnimationFrame(run_game);
}

function main() {
    munge_config();
    const canvas = canvas_to_window();
    const gfx = new Graphics(canvas.getContext("2d"));
    _game = new Game(gfx, 19, 19);
    _game.resize(canvas.width, canvas.height);
    window.addEventListener('resize', canvas_resize, false);
    document.addEventListener('mousedown', Game._event_mousedown);
    document.addEventListener('mouseup', Game._event_mouseup);
    document.addEventListener('mousemove', Game._event_mousemove);
    run_game();
}

function pure() {
    console.error("attempt to call a PURE function, you degenerate!");
}

</script>
</body>
</html>
